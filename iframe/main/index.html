<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<title>Ace Editor - EDA</title>
		<link rel="stylesheet" href="/iframe/style/body.css" />
	</head>
	<body>
		<div id="app">
			<!-- 左侧可滚动侧边栏 -->
			<div id="sidebar">
				<ul>
					<li><button id="run-btn">运行</button></li>
					<!-- 后续可在此添加更多 <li><button>...</button></li> -->
				</ul>
			</div>

			<!-- 右侧编辑器 -->
			<div id="editor-container">
				<div id="editor"></div>
			</div>
		</div>

		<!-- Ace 资源（全静态加载） -->
		<script src="/iframe/script/Ace_Editor/ace.js"></script>
		<script src="/iframe/script/Ace_Editor/ext-language_tools.js"></script>
		<script src="/iframe/script/Ace_Editor/mode-javascript.js"></script>
		<script src="/iframe/script/Ace_Editor/theme-monokai.js"></script>

		<script src="/iframe/script/eda_coder/allmethod.js"></script>

		<script>
			// 初始化 Ace 编辑器
			const editor = ace.edit('editor');
			editor.session.setMode('ace/mode/javascript');
			editor.setTheme('ace/theme/monokai');
			editor.setValue('', -1);
			editor.setOptions({
				enableBasicAutocompletion: true,
				enableLiveAutocompletion: true,
				fontSize: 14,
				useWorker: false,
				highlightActiveLine: true,
				showPrintMargin: false,
			});

			// 确保 completers 数组存在
			if (!editor.completers) {
				editor.completers = [];
			}

			// ========== 自动注册 EDA 智能补全 ==========
			const edcode = window.edcode;
			const completers = [];

			for (const e of edcode) {
				completers.push(
					{
						caption: e.methodPath,
						value: e.methodPath + '()',
						score: 1000,
						meta: 'method',
						docText: e.description,
					},
					{
						caption: e.description,
						value: e.methodPath + '()',
						score: 999,
						meta: 'desc',
						docText: e.methodPath,
					},
				);
			}

			// 清除旧的自定义补全（防重复）
			editor.completers = editor.completers.filter((c) => !c.getCompletions || (c.meta !== 'method' && c.meta !== 'desc'));

			// 注册带上下文感知的 completer
			editor.completers.push({
				identifierRegexps: [/[\w\$\u00A2-\uFFFF]/], // 支持中文
				getCompletions: function (editor, session, pos, prefix, callback) {
					const { row, column } = pos;
					const tokens = session.getTokens(row);
					let tokenStart = 0;
					let currentToken = null;

					// 定位当前列所在的 token
					for (let i = 0; i < tokens.length; i++) {
						const token = tokens[i];
						const tokenEnd = tokenStart + token.value.length;
						if (column <= tokenEnd) {
							currentToken = token;
							break;
						}
						tokenStart = tokenEnd;
					}

					const tokenType = currentToken?.type || '';

					// 跳过字符串、注释、正则等上下文
					if (tokenType.includes('string') || tokenType.includes('comment') || tokenType.includes('regexp')) {
						return callback(null, []);
					}

					// 跳过包含非法字符的前缀（避免在参数、操作符后触发）
					if (/[\s"'\(\)\[\]\{\}\+\-\*\/\=\!\&\|\<\>]/.test(prefix)) {
						return callback(null, []);
					}

					// 空前缀不自动弹出（需手动 Ctrl+Space）
					if (prefix === '') {
						return callback(null, []);
					}
					// 仅当前缀严格匹配（开头匹配）时才补全
					const normalizedPrefix = prefix.toLowerCase();
					const matches = completers.filter((item) => item.caption.toLowerCase().startsWith(normalizedPrefix));
					callback(null, matches);
				},
			});

			// 绑定“运行”按钮
			document.getElementById('run-btn').addEventListener('click', () => {
				const code = editor.getValue().trim();
				if (!code) {
					console.log('编辑器为空，未执行任何代码。');
					return;
				}
				try {
					eval(code);
				} catch (error) {
					console.error('❌ 执行出错:', error);
				}
			});

			// ========================
			// 字体缩放 + 右下角提示
			// ========================

			let currentFontSize = 14; // 初始字号，与 setOptions 中一致
			const minFontSize = 8;
			const maxFontSize = 32;
			const fontSizeStep = 2;

			// 创建右下角提示元素
			const zoomIndicator = document.createElement('div');
			zoomIndicator.style.position = 'fixed';
			zoomIndicator.style.bottom = '10px';
			zoomIndicator.style.right = '10px';
			zoomIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
			zoomIndicator.style.color = '#fff';
			zoomIndicator.style.padding = '4px 8px';
			zoomIndicator.style.borderRadius = '4px';
			zoomIndicator.style.fontSize = '12px';
			zoomIndicator.style.zIndex = '9999';
			zoomIndicator.style.display = 'none'; // 初始隐藏
			document.body.appendChild(zoomIndicator);

			// 更新提示文本和编辑器字号
			function updateZoomIndicator() {
				const percent = Math.round((currentFontSize / 14) * 100);
				zoomIndicator.textContent = `${percent}%`;
				zoomIndicator.style.display = 'block';

				// 更新 Ace 编辑器字体
				editor.setFontSize(currentFontSize);

				// 3秒后自动隐藏
				clearTimeout(window._zoomHideTimer);
				window._zoomHideTimer = setTimeout(() => {
					zoomIndicator.style.display = 'none';
				}, 3000);
			}

			// 监听 Ctrl + 鼠标滚轮
			editor.container.addEventListener(
				'wheel',
				(e) => {
					if (e.ctrlKey) {
						e.preventDefault(); // 阻止浏览器默认缩放
						if (e.deltaY < 0) {
							if (currentFontSize < maxFontSize) {
								currentFontSize += fontSizeStep;
							}
						} else if (e.deltaY > 0) {
							if (currentFontSize > minFontSize) {
								currentFontSize -= fontSizeStep;
							}
						}
						updateZoomIndicator();
					}
				},
				{ passive: false },
			); // passive: false 是为了能调用 preventDefault()
		</script>
	</body>
</html>
